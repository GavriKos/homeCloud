{% extends 'base.html' %}
{% block title %}–ê–¥–º–∏–Ω–∫–∞ ‚Äî HomeCloud{% endblock %}
{% block content %}
<h1 class="mb-4">–ê–¥–º–∏–Ω—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: –≤—Å–µ —à–∞—Ä—ã</h1>
<div class="table-responsive mb-5">
<table class="table table-bordered table-hover align-middle bg-white">
    <thead class="table-light">
        <tr>
            <th>MD5</th>
            <th>–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ</th>
            <th>–°—Å—ã–ª–∫–∞</th>
        </tr>
    </thead>
    <tbody>
        {% for share in shares %}
        <tr>
            <td class="text-monospace small">{{ share['md5'] }}</td>
            <td>{{ share['path'] }}</td>
            <td><a class="btn btn-sm btn-outline-primary" href="/share/{{ share['md5'] }}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
<h2 class="mb-3">–î–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫ –≤ UPLOAD_FOLDER</h2>
<div id="folder-tree" class="folder-tree"></div>
{% endblock %}
{% block scripts %}
<script>
function createFolderNode(node) {
    const li = document.createElement('li');
    const icon = document.createElement('span');
    icon.className = 'folder-icon';
    icon.textContent = node.children && node.children.length > 0 ? 'üìÅ' : 'üìÇ';
    li.appendChild(icon);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = node.name;
    li.appendChild(nameSpan);
    // –†–∞–∑–º–µ—Ä –ø–∞–ø–∫–∏
    const sizeSpan = document.createElement('span');
    sizeSpan.textContent = ` (${node.size})`;
    sizeSpan.style.color = '#666';
    sizeSpan.style.fontSize = '0.9em';
    li.appendChild(sizeSpan);
    // –ö–Ω–æ–ø–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
    if (node.is_shared) {
        const copyBtn = document.createElement('button');
        copyBtn.textContent = '—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É';
        copyBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            const url = window.location.origin + '/share/' + node.md5;
            navigator.clipboard.writeText(url).then(() => {
                copyBtn.textContent = '—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    copyBtn.textContent = '—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Å—ã–ª–∫—É';
                }, 2000);
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
            });
        };
        li.appendChild(copyBtn);
    } else {
        const shareBtn = document.createElement('button');
        shareBtn.textContent = '—Ä–∞—Å—à–∞—Ä–∏—Ç—å';
        shareBtn.className = 'btn btn-sm btn-primary ms-2';
        shareBtn.onclick = function(e) {
            e.stopPropagation();
            shareBtn.disabled = true;
            fetch('/admin/share-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: node.path })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (res.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∞—Ä–∏—Ç—å –ø–∞–ø–∫—É'));
                    shareBtn.disabled = false;
                }
            })
            .catch(() => {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                shareBtn.disabled = false;
            });
        };
        li.appendChild(shareBtn);
    }
    if (node.children && node.children.length > 0) {
        li.classList.add('collapsed');
        li.addEventListener('click', function(e) {
            e.stopPropagation();
            li.classList.toggle('collapsed');
            icon.textContent = li.classList.contains('collapsed') ? 'üìÅ' : 'üìÇ';
        });
        const ul = document.createElement('ul');
        for (const child of node.children) {
            ul.appendChild(createFolderNode(child));
        }
        li.appendChild(ul);
    }
    return li;
}

fetch('/admin/folder-tree')
    .then(r => r.json())
    .then(tree => {
        const container = document.getElementById('folder-tree');
        const ul = document.createElement('ul');
        for (const node of tree) {
            ul.appendChild(createFolderNode(node));
        }
        container.appendChild(ul);
    });
</script>
{% endblock %} 