{% extends 'base.html' %}
{% block title %}{{ _('list_of_shares') }} â€” HomeCloud{% endblock %}
{% block layout %}
<div class="row">
  <div class="col-md-3 mb-4">
    {% block sidebar %}
      {% include 'admin_sidebar.html' %}
    {% endblock %}
  </div>
  <div class="col-md-9">
    {% block content %}
    <h2 class="mb-4">{{ _('list_of_shares') }}</h2>

    <!-- Global actions -->
    <div class="mb-3">
        <button id="checkAllBtn" class="btn btn-info me-2">{{ _('check_all_integrity') }}</button>
        <button id="reindexAllBtn" class="btn btn-warning">{{ _('reindex_all') }}</button>
    </div>

    <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle bg-white">
        <thead class="table-light">
            <tr>
                <th>{{ _('md5') }}</th>
                <th>{{ _('folder_path') }}</th>
                <th>{{ _('link') }}</th>
                <th>{{ _('actions') }}</th>
            </tr>
        </thead>
        <tbody>
            {% for share in shares %}
            <tr>
                <td class="text-monospace small">{{ share['md5'] }}</td>
                <td>{{ share['path'] }}</td>
                <td>
                    <a class="btn btn-sm btn-outline-primary me-1" href="/share/{{ share['md5'] }}" target="_blank">{{ _('open') }}</a>
                    <button class="btn btn-sm btn-primary share-link-btn" data-share-md5="{{ share['md5'] }}">
                        <i class="bi bi-share"></i> {{ _('share_link') }}
                    </button>
                </td>
                <td>
                    <button class="btn btn-sm btn-info me-1 check-integrity-btn" data-share-md5="{{ share['md5'] }}">{{ _('check_integrity') }}</button>
                    <button class="btn btn-sm btn-warning me-1 reindex-btn" data-share-md5="{{ share['md5'] }}">{{ _('reindex') }}</button>
                    <button class="btn btn-sm btn-danger delete-share-btn" data-share-md5="{{ share['md5'] }}">{{ _('delete') }}</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    {% endblock %}
  </div>
</div>

<!-- Modal for displaying results -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">{{ _('integrity_check_result') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
                <!-- Results will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Universal message modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">{{ _('message') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">{{ _('confirm') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Confirmation message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('cancel') }}</button>
                <button type="button" class="btn btn-primary" id="confirmModalConfirm">{{ _('yes') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Share modal -->
{% include 'admin_templates/admin_share_modal.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check integrity for individual share
    document.querySelectorAll('.check-integrity-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const shareMd5 = this.dataset.shareMd5;
            this.disabled = true;
            this.textContent = '...';

            fetch(`/admin/check-integrity/${shareMd5}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showIntegrityResult(data, false);
                    } else {
                        showMessage('{{ _("error") }}', data.error || '{{ _("unknown_error") }}', 'error');
                    }
                })
                .catch(error => {
                    console.log(error);
                    showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
                })
                .finally(() => {
                    this.disabled = false;
                    this.textContent = '{{ _("check_integrity") }}';
                });
        });
    });

    // Reindex individual share
    document.querySelectorAll('.reindex-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const shareMd5 = this.dataset.shareMd5;
            const button = this;

            showConfirm('{{ _("confirm") }}', '{{ _("confirm_reindex") }}', function() {
                button.disabled = true;
                button.textContent = '...';

                fetch(`/admin/reindex/${shareMd5}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showReindexResult(data, false);
                    } else {
                        showMessage('{{ _("error") }}', data.error || '{{ _("unknown_error") }}', 'error');
                    }
                })
                .catch(error => {
                    showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
                })
                .finally(() => {
                    button.disabled = false;
                    button.textContent = '{{ _("reindex") }}';
                });
            });
        });
    });

    // Check all integrity
    document.getElementById('checkAllBtn').addEventListener('click', function() {
        this.disabled = true;
        this.textContent = '...';

        fetch('/admin/check-all-integrity')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showIntegrityResult(data, true);
                } else {
                    showMessage('{{ _("error") }}', data.error || '{{ _("unknown_error") }}', 'error');
                }
            })
            .catch(error => {
                showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = '{{ _("check_all_integrity") }}';
            });
    });

    // Reindex all
    document.getElementById('reindexAllBtn').addEventListener('click', function() {
        const button = this;

        showConfirm('{{ _("confirm") }}', '{{ _("confirm_reindex_all") }}', function() {
            button.disabled = true;
            button.textContent = '...';

            fetch('/admin/reindex-all', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showReindexResult(data, true);
                } else {
                    showMessage('{{ _("error") }}', data.error || '{{ _("unknown_error") }}', 'error');
                }
            })
            .catch(error => {
                showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = '{{ _("reindex_all") }}';
            });
        });
    });

    // Delete share
    document.querySelectorAll('.delete-share-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const shareMd5 = this.dataset.shareMd5;
            const button = this;

            showConfirm('{{ _("confirm") }}', '{{ _("confirm_delete_share") }}', function() {
                button.disabled = true;
                button.textContent = '...';

                fetch(`/admin/delete-share/${shareMd5}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showMessage('{{ _("message") }}', '{{ _("share_deleted_successfully") }}', 'success');
                        setTimeout(() => location.reload(), 1500); // Reload page after showing success message
                    } else {
                        showMessage('{{ _("error") }}', data.error || '{{ _("unknown_error") }}', 'error');
                    }
                })
                .catch(error => {
                    console.log(error);
                    showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
                })
                .finally(() => {
                    button.disabled = false;
                    button.textContent = '{{ _("delete") }}';
                });
            });
        });
    });

    // Universal function to show messages in modal
    function showMessage(title, message, type = 'info') {
        document.getElementById('messageModalTitle').textContent = title;
        const body = document.getElementById('messageModalBody');

        let alertClass = 'alert-info';
        if (type === 'error') alertClass = 'alert-danger';
        else if (type === 'success') alertClass = 'alert-success';
        else if (type === 'warning') alertClass = 'alert-warning';

        body.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
        new bootstrap.Modal(document.getElementById('messageModal')).show();
    }

    // Universal function to show confirmation modal
    function showConfirm(title, message, onConfirm) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').innerHTML = `<p class="mb-0">${message}</p>`;

        const confirmBtn = document.getElementById('confirmModalConfirm');
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));

        // Remove any existing event listeners
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        const newConfirmBtn = document.getElementById('confirmModalConfirm');

        // Add new event listener
        newConfirmBtn.addEventListener('click', function() {
            modal.hide();
            onConfirm();
        });

        modal.show();
    }

    function showIntegrityResult(data, isAll) {
        let html = '';

        if (isAll) {
            html += `<div class="mb-3">
                <h6>{{ _('summary') }}</h6>
                <p><strong>{{ _('total_shares') }}:</strong> ${data.total_shares}</p>
                <p><strong>{{ _('total_missing_files') }}:</strong> ${data.total_missing_files}</p>
                <p><strong>{{ _('total_extra_files') }}:</strong> ${data.total_extra_files}</p>
                <p><strong>{{ _('status') }}:</strong>
                    <span class="badge ${data.all_ok ? 'bg-success' : 'bg-warning'}">
                        ${data.all_ok ? '{{ _("integrity_ok") }}' : '{{ _("issues_found") }}'}
                    </span>
                </p>
            </div>`;

            if (data.shares && data.shares.length > 0) {
                html += '<h6>{{ _("details_by_share") }}</h6>';
                data.shares.forEach(share => {
                    html += `<div class="border p-2 mb-2">
                        <p><strong>{{ _('path') }}:</strong> ${share.path}</p>`;
                    if (share.error) {
                        html += `<p class="text-danger"><strong>{{ _('error') }}:</strong> ${share.error}</p>`;
                    } else {
                        html += `<p><strong>{{ _('files_in_db') }}:</strong> ${share.files_in_db}</p>
                                <p><strong>{{ _('files_on_disk') }}:</strong> ${share.files_on_disk}</p>
                                <p><strong>{{ _('missing_files') }}:</strong> ${share.missing_files}</p>
                                <p><strong>{{ _('extra_files') }}:</strong> ${share.extra_files}</p>
                                <p><strong>{{ _('status') }}:</strong>
                                    <span class="badge ${share.is_ok ? 'bg-success' : 'bg-warning'}">
                                        ${share.is_ok ? '{{ _("integrity_ok") }}' : '{{ _("issues_found") }}'}
                                    </span>
                                </p>`;
                    }
                    html += '</div>';
                });
            }
        } else {
            html += `<p><strong>{{ _('share_path') }}:</strong> ${data.share_path}</p>
                    <p><strong>{{ _('files_in_db') }}:</strong> ${data.files_in_db}</p>
                    <p><strong>{{ _('files_on_disk') }}:</strong> ${data.files_on_disk}</p>
                    <p><strong>{{ _('missing_files') }}:</strong> ${data.missing_files}</p>
                    <p><strong>{{ _('extra_files') }}:</strong> ${data.extra_files}</p>
                    <p><strong>{{ _('status') }}:</strong>
                        <span class="badge ${data.is_ok ? 'bg-success' : 'bg-warning'}">
                            ${data.is_ok ? '{{ _("integrity_ok") }}' : '{{ _("issues_found") }}'}
                        </span>
                    </p>`;
        }

        document.getElementById('resultModalTitle').textContent = '{{ _("integrity_check_result") }}';
        document.getElementById('resultModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

    function showReindexResult(data, isAll) {
        let html = '';

        if (isAll) {
            html += `<div class="mb-3">
                <h6>{{ _('summary') }}</h6>
                <p><strong>{{ _('total_shares') }}:</strong> ${data.total_shares}</p>
                <p><strong>{{ _('total_files_removed') }}:</strong> ${data.total_files_removed}</p>
                <p><strong>{{ _('total_files_added') }}:</strong> ${data.total_files_added}</p>
            </div>`;

            if (data.shares && data.shares.length > 0) {
                html += '<h6>{{ _("details_by_share") }}</h6>';
                data.shares.forEach(share => {
                    html += `<div class="border p-2 mb-2">
                        <p><strong>{{ _('path') }}:</strong> ${share.path}</p>`;
                    if (share.error) {
                        html += `<p class="text-danger"><strong>{{ _('error') }}:</strong> ${share.error}</p>`;
                    } else {
                        html += `<p><strong>{{ _('files_removed') }}:</strong> ${share.files_removed}</p>
                                <p><strong>{{ _('files_added') }}:</strong> ${share.files_added}</p>`;
                    }
                    html += '</div>';
                });
            }
        } else {
            html += `<p><strong>{{ _('share_path') }}:</strong> ${data.share_path}</p>
                    <p><strong>{{ _('files_removed') }}:</strong> ${data.files_removed}</p>
                    <p><strong>{{ _('files_added') }}:</strong> ${data.files_added}</p>`;
        }

        document.getElementById('resultModalTitle').textContent = '{{ _("reindex_complete") }}';
        document.getElementById('resultModalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }

    // Share link functionality
    document.querySelectorAll('.share-link-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const shareMd5 = this.dataset.shareMd5;
            showShareModal(shareMd5);
        });
    });
});

</script>
{% endblock %}