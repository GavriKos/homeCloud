{% extends 'base.html' %}
{% block title %}Дерево папок — HomeCloud{% endblock %}
{% block layout %}
<div class="row">
  <div class="col-md-3 mb-4">
    {% block sidebar %}
      {% include 'admin_sidebar.html' %}
    {% endblock %}
  </div>
  <div class="col-md-9">
    {% block content %}
    <h2 class="mb-3">{{ _('folder_tree') }}</h2>
    <div id="folder-tree" class="folder-tree"></div>
    {% endblock %}
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function createFolderNode(node) {
    const li = document.createElement('li');
    const icon = document.createElement('span');
    icon.className = 'folder-icon';
    icon.textContent = node.children && node.children.length > 0 ? '📁' : '📂';
    li.appendChild(icon);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = node.name;
    li.appendChild(nameSpan);
    // Размер папки
    const sizeSpan = document.createElement('span');
    sizeSpan.textContent = ` (${node.size})`;
    sizeSpan.style.color = '#666';
    sizeSpan.style.fontSize = '0.9em';
    li.appendChild(sizeSpan);
    // Кнопка в зависимости от статуса
    if (node.is_shared) {
        const copyBtn = document.createElement('button');
        copyBtn.textContent = "{{ _('copy_public_link') }}";
        copyBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            const url = window.location.origin + '/share/' + node.md5;
            navigator.clipboard.writeText(url).then(() => {
                copyBtn.textContent = "{{ _('copied') }}";
                setTimeout(() => {
                    copyBtn.textContent = "{{ _('copy_public_link') }}";
                }, 2000);
            }).catch(() => {
                alert('Не удалось скопировать ссылку');
            });
        };
        li.appendChild(copyBtn);
    } else {
        const shareBtn = document.createElement('button');
        shareBtn.textContent = "{{ _('share') }}";
        shareBtn.className = 'btn btn-sm btn-primary ms-2';
        shareBtn.onclick = function(e) {
            e.stopPropagation();
            shareBtn.disabled = true;
            fetch('/admin/share-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: node.path })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + (res.error || 'Не удалось расшарить папку'));
                    shareBtn.disabled = false;
                }
            })
            .catch(() => {
                alert('Ошибка сети');
                shareBtn.disabled = false;
            });
        };
        li.appendChild(shareBtn);
    }
    if (node.children && node.children.length > 0) {
        li.classList.add('collapsed');
        li.addEventListener('click', function(e) {
            e.stopPropagation();
            li.classList.toggle('collapsed');
            icon.textContent = li.classList.contains('collapsed') ? '📁' : '📂';
        });
        const ul = document.createElement('ul');
        for (const child of node.children) {
            ul.appendChild(createFolderNode(child));
        }
        li.appendChild(ul);
    }
    return li;
}

fetch('/admin/folder-tree')
    .then(r => r.json())
    .then(tree => {
        const container = document.getElementById('folder-tree');
        const ul = document.createElement('ul');
        for (const node of tree) {
            ul.appendChild(createFolderNode(node));
        }
        container.appendChild(ul);
    });
</script>
{% endblock %} 