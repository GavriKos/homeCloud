{% extends 'base.html' %}
{% block title %}Дерево папок — HomeCloud{% endblock %}
{% block layout %}
<div class="row">
  <div class="col-md-3 mb-4">
    {% block sidebar %}
      {% include 'admin_sidebar.html' %}
    {% endblock %}
  </div>
  <div class="col-md-9">
    {% block content %}
    <h2 class="mb-3">{{ _('folder_tree') }}</h2>
    <div id="folder-tree" class="folder-tree"></div>
    {% endblock %}
  </div>
</div>

<!-- Universal message modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">{{ _('message') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">{{ _('confirm') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Confirmation message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('cancel') }}</button>
                <button type="button" class="btn btn-primary" id="confirmModalConfirm">{{ _('yes') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Share modal -->
{% include 'admin_templates/admin_share_modal.html' %}

<script>
// Universal function to show messages in modal
function showMessage(title, message, type = 'info') {
    document.getElementById('messageModalTitle').textContent = title;
    const body = document.getElementById('messageModalBody');

    let alertClass = 'alert-info';
    if (type === 'error') alertClass = 'alert-danger';
    else if (type === 'success') alertClass = 'alert-success';
    else if (type === 'warning') alertClass = 'alert-warning';

    body.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
    new bootstrap.Modal(document.getElementById('messageModal')).show();
}

// Universal function to show confirmation modal
function showConfirm(title, message, onConfirm) {
    document.getElementById('confirmModalTitle').textContent = title;
    document.getElementById('confirmModalBody').innerHTML = `<p class="mb-0">${message}</p>`;

    const confirmBtn = document.getElementById('confirmModalConfirm');
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // Remove any existing event listeners
    confirmBtn.replaceWith(confirmBtn.cloneNode(true));
    const newConfirmBtn = document.getElementById('confirmModalConfirm');

    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
        modal.hide();
        onConfirm();
    });

    modal.show();
}
function createFolderNode(node) {
    const li = document.createElement('li');
    const icon = document.createElement('span');
    icon.className = 'folder-icon';
    icon.textContent = node.children && node.children.length > 0 ? '📁' : '📂';
    li.appendChild(icon);
    const nameSpan = document.createElement('span');
    nameSpan.textContent = node.name;
    li.appendChild(nameSpan);
    // Folder size display
    const sizeSpan = document.createElement('span');
    sizeSpan.textContent = ` (${node.size})`;
    sizeSpan.style.color = '#666';
    sizeSpan.style.fontSize = '0.9em';
    li.appendChild(sizeSpan);
    // Button based on sharing status
    if (node.is_shared) {
        const copyBtn = document.createElement('button');
        copyBtn.textContent = "{{ _('copy_public_link') }}";
        copyBtn.className = 'btn btn-sm btn-outline-secondary ms-2';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            const url = window.location.origin + '/share/' + node.md5;
            navigator.clipboard.writeText(url).then(() => {
                copyBtn.textContent = "{{ _('copied') }}";
                setTimeout(() => {
                    copyBtn.textContent = "{{ _('copy_public_link') }}";
                }, 2000);
            }).catch(() => {
                showMessage('{{ _("error") }}', '{{ _("copy_link_failed") }}', 'error');
            });
        };
        li.appendChild(copyBtn);

        // Add share button
        const shareBtn = document.createElement('button');
        shareBtn.innerHTML = '<i class="bi bi-share"></i> {{ _("share_link") }}';
        shareBtn.className = 'btn btn-sm btn-primary ms-1';
        shareBtn.onclick = function(e) {
            e.stopPropagation();
            showShareModal(node.md5);
        };
        li.appendChild(shareBtn);
    } else {
        const shareBtn = document.createElement('button');
        shareBtn.textContent = "{{ _('share') }}";
        shareBtn.className = 'btn btn-sm btn-primary ms-2';
        shareBtn.onclick = function(e) {
            e.stopPropagation();
            shareBtn.disabled = true;
            fetch('/admin/share-folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: node.path })
            })
            .then(r => r.json())
            .then(res => {
                if (res.success) {
                    location.reload();
                } else {
                    showMessage('{{ _("error") }}', res.error || '{{ _("unknown_error") }}', 'error');
                    shareBtn.disabled = false;
                }
            })
            .catch(() => {
                showMessage('{{ _("error") }}', '{{ _("network_error") }}', 'error');
                shareBtn.disabled = false;
            });
        };
        li.appendChild(shareBtn);
    }
    if (node.children && node.children.length > 0) {
        li.classList.add('collapsed');
        li.addEventListener('click', function(e) {
            e.stopPropagation();
            li.classList.toggle('collapsed');
            icon.textContent = li.classList.contains('collapsed') ? '📁' : '📂';
        });
        const ul = document.createElement('ul');
        for (const child of node.children) {
            ul.appendChild(createFolderNode(child));
        }
        li.appendChild(ul);
    }
    return li;
}

fetch('/admin/folder-tree')
    .then(r => r.json())
    .then(tree => {
        const container = document.getElementById('folder-tree');
        const ul = document.createElement('ul');
        for (const node of tree) {
            ul.appendChild(createFolderNode(node));
        }
        container.appendChild(ul);
    });

</script>
{% endblock %}