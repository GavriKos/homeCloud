{% extends 'base.html' %}
{% block title %}{{ _('file_viewer') }} â€” HomeCloud{% endblock %}
{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
    body {
        background: #f8f9fa;
    }

    .media-viewer-card {
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08), 0 1.5px 4px rgba(0, 0, 0, 0.04);
        border-radius: 1.2rem;
        background: #fff;
        padding: 2rem 2.5rem;
        max-width: 900px;
        margin: 40px auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 60vh;
    }

    .media-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
    }

    .media-arrow {
        font-size: 2.1rem;
        color: #0d6efd;
        cursor: pointer;
        transition: color 0.18s, background 0.18s, box-shadow 0.18s;
        user-select: none;
        border: none;
        outline: none;
        background: transparent;
        border-radius: 0.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: none;
    }

    .media-arrow:active,
    .media-arrow:focus {
        background: #e3f0fd;
    }

    .media-arrow:hover {
        color: #1565c0;
        background: #e3f0fd;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.07);
    }

    .media-img {
        max-width: 80vw;
        max-height: 65vh;
        border-radius: 0.7rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
        background: #f1f3f4;
    }

    .media-info {
        margin-top: 1.2rem;
        color: #555;
        font-size: 1.1rem;
    }

    @media (max-width: 600px) {
        .media-viewer-card {
            padding: 0.5rem 0.2rem;
            max-width: 100vw;
            margin: 0;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .media-img {
            max-width: 98vw;
            max-height: 38vh;
        }

        .media-controls {
            gap: 0.7rem;
            margin-bottom: 0.7rem;
            margin-top: auto;
            order: 10;
            width: 100%;
            justify-content: center;
        }

        .media-arrow {
            font-size: 1.7rem;
            padding: 0.15em 0.25em;
            background: transparent;
        }

        .media-info {
            font-size: 1rem;
            margin-top: 0.7rem;
            order: 9;
        }
    }

    /* Mobile buttons under image */
    @media (max-width: 600px) {
        .media-controls {
            flex-direction: row;
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="media-viewer-card">
    <a id="media-link" data-fancybox="gallery" href="image1.jpg">
        <img id="media" src="image1.jpg" alt="Media" class="media-img">
    </a>
    <div class="media-info text-center">
        <span id="media-counter">1 / 1</span>
    </div>
    <div class="media-controls mb-3">
        <span class="media-arrow" id="prev" title="{{ _('previous') }}"><i class="bi bi-chevron-left"></i></span>
        <span class="media-arrow" id="next" title="{{ _('next') }}"><i class="bi bi-chevron-right"></i></span>
    </div>
</div>
{% endblock %}

<!-- Universal message modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalTitle">{{ _('message') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">{{ _('confirm') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Confirmation message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('cancel') }}</button>
                <button type="button" class="btn btn-primary" id="confirmModalConfirm">{{ _('yes') }}</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
<script>
    // Universal function to show messages in modal
    function showMessage(title, message, type = 'info') {
        document.getElementById('messageModalTitle').textContent = title;
        const body = document.getElementById('messageModalBody');

        let alertClass = 'alert-info';
        if (type === 'error') alertClass = 'alert-danger';
        else if (type === 'success') alertClass = 'alert-success';
        else if (type === 'warning') alertClass = 'alert-warning';

        body.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
        new bootstrap.Modal(document.getElementById('messageModal')).show();
    }

    // Universal function to show confirmation modal
    function showConfirm(title, message, onConfirm) {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalBody').innerHTML = `<p class="mb-0">${message}</p>`;

        const confirmBtn = document.getElementById('confirmModalConfirm');
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));

        // Remove any existing event listeners
        confirmBtn.replaceWith(confirmBtn.cloneNode(true));
        const newConfirmBtn = document.getElementById('confirmModalConfirm');

        // Add new event listener
        newConfirmBtn.addEventListener('click', function () {
            modal.hide();
            onConfirm();
        });

        modal.show();
    }
    let currentIndex = 0;
    let mediaList = null;
    let viewedObject = null;
    const paths = window.location.pathname.split("/").filter(path => path !== "");
    const md5 = paths[paths.length - 1];

    function updateCounter() {
        if (mediaList) {
            $("#media-counter").text((currentIndex + 1) + " / " + mediaList.length);
        }
    }

    function loadAll() {
        $.ajax({
            url: '/share/all/' + md5,
            method: 'GET',
            success: function (data) {
                mediaList = JSON.parse(data)["mediaList"];
                currentIndex = 0;
                loadMedia(currentIndex);
                updateCounter();
            },
            error: function () {
                showMessage('{{ _("error") }}', '{{ _("media_load_error") }}', 'error');
            }
        });
    }

    function loadMedia(index) {
        console.log(mediaList);
        if (!mediaList || !mediaList[index]) return;
        updateCounter();
        let mimetype = mediaList[index]["mimetype"];
        if (mimetype == "image") {
            $('#media-link').removeAttr("data-type");
            $('#media-link').attr('data-fancybox', "gallery");
            $.ajax({
                url: '/share/' + md5 + '/' + mediaList[index]["md5"],
                method: 'GET',
                xhrFields: { responseType: 'blob' },
                success: function (data) {
                    const url = URL.createObjectURL(data);
                    $('#media').attr('src', url);
                    $('#media-link').attr('href', url);
                    fancyAdaptateImage();
                    if (viewedObject != null) {
                        URL.revokeObjectURL(viewedObject);
                    }
                    viewedObject = url;
                },
                error: function () {
                    showMessage('{{ _("error") }}', '{{ _("media_load_error") }}', 'error');
                }
            });
        } else
            if (mimetype == "video") {
                $('#media').attr('src', "/static/video_without_thumb.jpg");
                $('#media-link').attr('href', '/share/' + md5 + '/' + mediaList[index]["md5"]);
                $('#media-link').removeAttr("data-type");
                $('#media-link').attr('data-fancybox', "gallery");
                fancyAdaptateVideo();
            } else
                if (mimetype == "maptrack") {
                    $('#media').attr('src', "/static/map_without_thumb.jpg");
                    $('#media-link').attr('href', "/external-viewer/maptrack/" + md5 + '/' + mediaList[index]["md5"]);
                    $('#media-link').attr('data-type', "iframe");
                    $('#media-link').attr('data-fancybox', "iframe");
                    fancyAdaptateIFrameMap();
                }
                else {
                    // Clear any previous fancybox settings
                    $('#media-link').removeAttr("data-fancybox");
                    $('#media-link').removeAttr("data-type");
                    $('#media-link').removeAttr("href");

                    // Show unknown content message
                    $('#media').attr('src', 'data:image/svg+xml;base64,' + btoa(`
                <svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
                    <rect width="400" height="300" fill="#f8f9fa" stroke="#dee2e6" stroke-width="2"/>
                    <text x="200" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" fill="#6c757d">
                        {{ _("unknown_content") }}
                    </text>
                    <text x="200" y="160" text-anchor="middle" font-family="Arial, sans-serif" font-size="14" fill="#adb5bd">
                        MIME: ${mediaList[index]["mimetype"] || "unknown"}
                    </text>
                </svg>
            `));

                    // Disable fancybox for unknown content
                    $('#media-link').off('click').on('click', function (e) {
                        e.preventDefault();
                        return false;
                    });
                }
    }

    $('#prev').click(function () {
        if (!mediaList) return;
        currentIndex = (currentIndex > 0) ? currentIndex - 1 : mediaList.length - 1;
        loadMedia(currentIndex);
    });

    $('#next').click(function () {
        if (!mediaList) return;
        currentIndex = (currentIndex < mediaList.length - 1) ? currentIndex + 1 : 0;
        loadMedia(currentIndex);
    });

    loadAll();

    function fancyAdaptateImage() {
        $("[data-fancybox]").fancybox({
            arrows: false,
            infobar: true,
            toolbar: true,
            loop: true,
            iframe: { css: {} },
            // closeClickOutside: true // Doesn't work, so custom handler below
            afterShow: function (instance, current) {
                // Remove previous handler if exists
                $(document).off('mousedown.fancybox-close');
                // Add new handler
                $('.fancybox-bg').on('mousedown.fancybox-close', function (e) {
                    // Check that click was on overlay, not on image
                    if ($(e.target).hasClass('fancybox-bg')) {
                        $.fancybox.close();
                    }
                });
            },
            afterClose: function () {
                $('.fancybox-bg').off('mousedown.fancybox-close');
            }
        });
    }
    function fancyAdaptateVideo() {
        $('[data-fancybox]').fancybox({
            type: 'iframe',
            iframe: { preload: false },
            backFocus: false,
            buttons: ["close"]
        });
    }
    function fancyAdaptateIFrameMap() {
        $('[data-fancybox]').fancybox({
            type: 'iframe',
            backFocus: false,
            buttons: ["close"],
            iframe: { css: { width: '80%', height: '80%' } }
        });
    }
</script>
{% endblock %}